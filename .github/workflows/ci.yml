name: ðŸ§ª CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main

jobs:
  # ========================================
  # Job 1: Tests Backend
  # ========================================
  test-backend:
    name: ðŸ§ª Tests Backend (Pytest)
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: ['3.11', '3.12']
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v5
        with:
          lfs: true  # Pour tÃ©lÃ©charger le modÃ¨le ML
      
      - name: ðŸ Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      
      - name: ðŸ“¦ Install dependencies
        run: |
          cd backend
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio
      
      - name: ðŸ§ª Run tests with coverage
        run: |
          cd backend
          pytest tests/ -v --cov=app --cov-report=xml --cov-report=term
      
      - name: ðŸ“Š Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        if: matrix.python-version == '3.11'
        with:
          file: ./backend/coverage.xml
          flags: backend
          name: backend-coverage
          fail_ci_if_error: false
      
      - name: âœ… Test summary
        if: always()
        run: |
          echo "### ðŸ§ª Test Results" >> $GITHUB_STEP_SUMMARY
          echo "- Python Version: ${{ matrix.python-version }}" >> $GITHUB_STEP_SUMMARY
          echo "- Tests: âœ… Passed" >> $GITHUB_STEP_SUMMARY

  # ========================================
  # Job 2: Linting & Code Quality
  # ========================================
  lint:
    name: ðŸ” Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v5
      
      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: ðŸ“¦ Install linting tools
        run: |
          pip install flake8 black isort
      
      - name: ðŸ” Run Flake8
        run: |
          cd backend
          flake8 app/ --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 app/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
        continue-on-error: true
      
      - name: ðŸŽ¨ Check code formatting (Black)
        run: |
          cd backend
          black app/ --check --diff
        continue-on-error: true
      
      - name: ðŸ“‹ Check imports (isort)
        run: |
          cd backend
          isort app/ --check-only --diff
        continue-on-error: true

  # ========================================
  # Job 3: Security Scan
  # ========================================
  security:
    name: ðŸ” Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v5
      
      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: ðŸ“¦ Install safety
        run: pip install safety
      
      - name: ðŸ” Check dependencies for vulnerabilities
        run: |
          cd backend
          safety check -r requirements.txt --ignore 70612
        continue-on-error: true

  # ========================================
  # Job 4: Docker Build Test
  # ========================================
  docker-build:
    name: ðŸ³ Docker Build Test
    runs-on: ubuntu-latest
    needs: [test-backend]
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v5
        with:
          lfs: true
      
      - name: ðŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: ðŸ—ï¸ Build Docker image
        run: |
          docker build -t carprice:test .
      
      - name: âœ… Test Docker image
        run: |
          docker run --rm carprice:test python --version
      
      - name: ðŸ“¦ Image size
        run: |
          docker images carprice:test --format "Size: {{.Size}}"

  # ========================================
  # Job 5: Model Validation
  # ========================================
  validate-model:
    name: ðŸ¤– ML Model Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v5
        with:
          lfs: true
      
      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: ðŸ“¦ Install dependencies
        run: |
          pip install joblib scikit-learn==1.6.1 pandas
      
      - name: ðŸ” Validate model file
        run: |
          python -c "
          import joblib
          import os
          
          model_path = 'ml/artifacts/model.joblib'
          
          # Check file exists
          if not os.path.exists(model_path):
              raise FileNotFoundError(f'Model not found: {model_path}')
          
          # Check file size
          size_mb = os.path.getsize(model_path) / (1024 * 1024)
          print(f'âœ… Model size: {size_mb:.2f} MB')
          
          # Load model
          model = joblib.load(model_path)
          print(f'âœ… Model type: {type(model).__name__}')
          print(f'âœ… Model loaded successfully!')
          "

  # ========================================
  # Job 6: Build Summary
  # ========================================
  summary:
    name: ðŸ“‹ Build Summary
    runs-on: ubuntu-latest
    needs: [test-backend, lint, security, docker-build, validate-model]
    if: always()
    
    steps:
      - name: ðŸ“Š Create summary
        run: |
          echo "# ðŸŽ‰ CI/CD Pipeline Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ§ª Backend Tests | ${{ needs.test-backend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” Code Quality | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” Security Scan | ${{ needs.security.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ³ Docker Build | ${{ needs.docker-build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ¤– Model Validation | ${{ needs.validate-model.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ðŸš€ **Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ‘¤ **Author:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
